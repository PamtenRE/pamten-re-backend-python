<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Resume–JD Matching — UI + Animations</title>
    <meta http-equiv="Cache-Control" content="no-store" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <style>
         :root {
            --bar: #0b4a86;
            --accent: #1e88e5;
            --bg: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            --card: #1f3149;
            --text: #f6f9ff;
            --muted: #c7d2e5;
            --border: #4a5f7a;
            --field-h: 36px;
            --radius: 12px;
            --head-fill-1: #eef7ff;
            --head-fill-2: #d6ecff;
            --head-text: #0b1d36;
            --head-border: #3da9fc;
            --ans-fill-1: #2c9aff;
            --ans-fill-2: #6fc3ff;
            --ans-text: #ffffff;
            --ans-br: rgba(255, 255, 255, .65);
            --glow: rgba(61, 169, 252, .35)
        }
        
        [data-theme="light"] {
            --bar: #0b4a86;
            --accent: #1e88e5;
            --bg: linear-gradient(180deg, #f6f9ff 0%, #eef5ff 60%, #ffe9d6 120%);
            --card: #ffffff;
            --text: #0f172a;
            --muted: #5b6b80;
            --border: #d9e3f0;
            --head-fill-1: #e7f3ff;
            --head-fill-2: #cfe8ff;
            --head-text: #0b1d36;
            --head-border: #2c9aff;
            --ans-fill-1: #2c9aff;
            --ans-fill-2: #6fc3ff;
            --ans-text: #ffffff;
            --ans-br: rgba(255, 255, 255, .55);
            --glow: rgba(61, 169, 252, .28)
        }
        
        * {
            box-sizing: border-box
        }
        
        html,
        body {
            min-height: 100%
        }
        
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
            line-height: 1.4
        }
        
        @keyframes cardIn {
            0% {
                opacity: 0;
                transform: translateY(10px) scale(.98)
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }
        
        @keyframes badgePop {
            0% {
                transform: scale(.8);
                opacity: 0
            }
            100% {
                transform: scale(1);
                opacity: 1
            }
        }
        
        .appbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bar);
            color: #fff;
            padding: 14px 16px;
            display: grid;
            grid-template-columns: 1fr auto;
            grid-template-rows: auto auto;
            align-items: center;
            column-gap: 10px;
            row-gap: 6px
        }
        
        .title {
            grid-column: 1;
            grid-row: 1;
            font-size: 20px;
            font-weight: 700;
            color: #fff
        }
        
        .ver {
            grid-column: 1 / -1;
            grid-row: 2;
            justify-self: start;
            background: rgba(12, 90, 168, .95);
            color: #fff;
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 600
        }
        
        #themeToggle {
            grid-column: 2;
            grid-row: 1;
            background: linear-gradient(135deg, var(--accent), #6fc3ff, var(--accent));
            background-size: 200% 200%;
            animation: sweep 6s linear infinite;
            color: #0b1d36;
            border: none;
            border-radius: 999px;
            padding: 8px 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .18)
        }
        
        @media (min-width:600px) {
            .appbar {
                grid-template-columns: 1fr auto auto;
                grid-template-rows: auto
            }
            .ver {
                grid-column: 2;
                grid-row: 1
            }
            #themeToggle {
                grid-column: 3;
                grid-row: 1
            }
        }
        
        .container {
            width: min(100%, 1040px);
            margin: 18px auto;
            padding-inline: 16px
        }
        
        .drop {
            border: 2px dashed #9ec7ff;
            border-radius: 14px;
            padding: 20px;
            background: var(--card);
            text-align: center;
            margin: 12px 0;
            box-shadow: 0 8px 22px rgba(0, 0, 0, .18)
        }
        
        .drop:hover {
            background: rgba(158, 199, 255, .08)
        }
        
        .hint {
            color: var(--muted);
            font-size: 13px;
            margin-top: 6px
        }
        
        input[type=file] {
            display: none
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--accent), #6fc3ff, var(--accent));
            background-size: 200% 200%;
            animation: sweep 6s linear infinite;
            color: #0b1d36;
            border: none;
            border-radius: 12px;
            padding: 0 16px;
            height: 36px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 26px rgba(61, 169, 252, .35)
        }
        
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 12px
        }
        
        .badge {
            background: #eef3fb;
            color: #0b1d36;
            border: 1px solid #cfe4ff;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 700;
            animation: badgePop .3s ease both
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr;
            row-gap: 12px;
            margin: 16px 0 8px
        }
        
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px
        }
        
        .field input[type="number"],
        .field select {
            height: 36px;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--card);
            color: var(--text)
        }
        
        #matchBtn,
        #csvBtn {
            width: 100%
        }
        
        #status {
            font-size: 13px;
            color: var(--muted)
        }
        
        #results {
            margin-top: 12px;
            display: grid;
            gap: 14px
        }
        
        .group {
            border: 2px dashed var(--border);
            border-radius: 14px;
            padding: 12px
        }
        
        .group h2 {
            margin: 2px 6px 10px 6px;
            font-size: 16px;
            opacity: .9
        }
        
        .card {
            position: relative;
            border-radius: 14px;
            padding: 14px;
            background: linear-gradient(var(--card), var(--card)) padding-box, linear-gradient(135deg, var(--accent), #6fc3ff, var(--accent)) border-box;
            border: 2px solid transparent;
            background-size: auto, 300% 300%;
            animation: cardIn .5s ease both, sweep 8s linear infinite;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .18)
        }
        
        .card h3 {
            margin: 0 0 10px
        }
        
        details {
            margin: 10px 0
        }
        
        details>summary {
            list-style: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 800;
            color: #0b1d36;
            background: linear-gradient(135deg, #e7f3ff, #cfe8ff);
            border: 2px solid #2c9aff
        }
        
        details>summary::-webkit-details-marker {
            display: none
        }
        
        details>summary::before {
            content: '▸';
            font-weight: 900;
            color: #0b1d36
        }
        
        details[open]>summary::before {
            content: '▾'
        }
        
        .chipline {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px
        }
        
        .answer-chip {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 800;
            color: #fff;
            background: linear-gradient(135deg, #2c9aff, #6fc3ff);
            border: 1.5px solid rgba(255, 255, 255, .6);
            animation: badgePop .25s ease both
        }
        
        .answer-chip.none {
            opacity: .9
        }
        
        @media (min-width:768px) {
            .controls {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                align-items: end
            }
            #matchBtn {
                grid-column: 1
            }
            #csvBtn {
                grid-column: 2
            }
            #status {
                grid-column: 1 / -1;
                justify-self: start;
                align-self: start;
                margin-top: 4px
            }
        }
    </style>
</head>

<body>
    <header class="appbar">
        <div class="title">Resume–JD Matching Plugin</div>
        <small class="ver">UI v2025-09-16</small>
        <button id="themeToggle"> Dark Mode</button>
    </header>

    <div class="container">
        <div id="resumeDZ" class="drop">
            <div><b> Upload Resume(s)</b></div>
            <div class="hint">Click “Choose File(s)” or drag & drop .pdf / .docx / .txt</div>
            <div style="margin-top:10px;">
                <label class="btn" for="resume">Choose File(s)</label>
                <input id="resume" type="file" accept=".pdf,.docx,.txt" multiple />
            </div>
            <div id="resumeList" class="chips" aria-live="polite"></div>
        </div>

        <div id="jdDZ" class="drop">
            <div><b> Upload Job Description(s)</b></div>
            <div class="hint">Click “Choose JD File(s)” or drag & drop .pdf / .docx / .txt</div>
            <div style="margin-top:10px;">
                <label class="btn" for="jdFiles">Choose JD File(s)</label>
                <input id="jdFiles" type="file" accept=".pdf,.docx,.txt" multiple />
            </div>
            <div id="jdList" class="chips" aria-live="polite"></div>
        </div>

        <div class="controls" role="group" aria-label="Matching controls">
            <div class="field"><label for="minPct">Match % ≥</label><input id="minPct" type="number" min="0" max="100" value="0"></div>
            <div class="field"><label for="minSkills">Min Skills</label><input id="minSkills" type="number" min="0" value="0"></div>
            <div class="field">
                <label for="sortBy">Sort by</label>
                <select id="sortBy">
                    <option value="desc">Score (High → Low)</option>
                    <option value="asc">Score (Low → High)</option>
                </select>
            </div>
            <button id="matchBtn" class="btn" type="button"> Match</button>
            <button id="csvBtn" class="btn" type="button"> Download CSV</button>
            <span id="status">ready</span>
        </div>

        <div id="results" aria-live="polite"></div>
    </div>

    <script>
        (function() {
            var $ = function(s) {
                return document.querySelector(s);
            };
            var themeToggle = $('#themeToggle');
            var savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            themeToggle.textContent = savedTheme === 'dark' ? ' Light Mode' : ' Dark Mode';
            themeToggle.addEventListener('click', function() {
                var html = document.documentElement;
                var next = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                themeToggle.textContent = next === 'dark' ? ' Light Mode' : ' Dark Mode';
            });

            var resumeInput = $('#resume'),
                resumeList = $('#resumeList');
            var jdInput = $('#jdFiles'),
                jdList = $('#jdList');

            function chips(el, files) {
                el.innerHTML = '';
                for (var i = 0; i < files.length; i++) {
                    var f = files[i];
                    var s = document.createElement('span');
                    s.className = 'badge';
                    s.style.animationDelay = (i * 30) + 'ms';
                    s.title = f.name;
                    s.textContent = f.name;
                    el.appendChild(s);
                }
            }
            resumeInput.addEventListener('change', function() {
                chips(resumeList, resumeInput.files);
            });
            jdInput.addEventListener('change', function() {
                chips(jdList, jdInput.files);
            });

            function wireDrop(zoneEl, inputEl, listEl) {
                zoneEl.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    zoneEl.style.background = 'rgba(158,199,255,.10)';
                });
                zoneEl.addEventListener('dragleave', function() {
                    zoneEl.style.background = 'var(--card)';
                });
                zoneEl.addEventListener('drop', function(e) {
                    e.preventDefault();
                    zoneEl.style.background = 'var(--card)';
                    var dt = new DataTransfer();
                    for (var i = 0; i < inputEl.files.length; i++) dt.items.add(inputEl.files[i]);
                    for (var j = 0; j < e.dataTransfer.files.length; j++) dt.items.add(e.dataTransfer.files[j]);
                    inputEl.files = dt.files;
                    chips(listEl, inputEl.files);
                });
                zoneEl.addEventListener('click', function(ev) {
                    if (ev.target.tagName !== 'LABEL') inputEl.click();
                });
            }
            wireDrop(document.getElementById('resumeDZ'), resumeInput, resumeList);
            wireDrop(document.getElementById('jdDZ'), jdInput, jdList);

            function parseResultTable(html) {
                var tmp = document.createElement('div');
                tmp.innerHTML = html;
                var allRows = tmp.querySelectorAll('tr');
                if (!allRows || allRows.length === 0) {
                    console.error('No rows from /upload. First bytes:', (html || '').slice(0, 300));
                    return [];
                }
                var out = [];
                for (var i = 1; i < allRows.length; i++) {
                    var tr = allRows[i];
                    var t = tr.children ? Array.prototype.slice.call(tr.children) : [];
                    var t0 = (t[0] && t[0].innerText) ? t[0].innerText : '';
                    var t1 = (t[1] && t[1].innerText) ? t[1].innerText : '0';
                    var t2 = (t[2] && t[2].innerText) ? t[2].innerText : '';
                    var t3 = (t[3] && t[3].innerText) ? t[3].innerText : '';
                    var t4 = (t[4] && t[4].innerText) ? t[4].innerText : '';
                    var t5 = (t[5] && t[5].innerText) ? t[5].innerText : '';
                    var t6 = (t[6] && t[6].innerText) ? t[6].innerText : '';
                    var t7 = (t[7] && t[7].innerHTML) ? t[7].innerHTML : '';
                    var t8 = (t[8] && t[8].innerHTML) ? t[8].innerHTML : '';
                    var t9 = (t[9] && t[9].innerHTML) ? t[9].innerHTML : '';
                    var t10 = (t[10] && t[10].innerHTML) ? t[10].innerHTML : '';
                    out.push({
                        jd: t0,
                        score: parseFloat(String(t1).replace('%', '')) || 0,
                        rLoc: t2,
                        jLoc: t3,
                        matched: t4 ? t4.split(',').map(function(s) {
                            return s.trim();
                        }).filter(Boolean) : [],
                        missing: t5 ? t5.split(',').map(function(s) {
                            return s.trim();
                        }).filter(Boolean) : [],
                        eduJobGap: t6,
                        eduPeriods: t7,
                        expPeriods: t8,
                        eduGaps: t9,
                        expGaps: t10
                    });
                }
                return out;
            }

            var escMap = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                '\\': '&#92;',
                ':': '&#58;',
                "'": '&#39;'
            };

            function esc(s) {
                return String(s).replace(/[&<>"'\\:]/g, function(c) {
                    return escMap[c];
                });
            }

            function htmlToItems(html) {
                if (!html) return [];
                var tmp = document.createElement('div');
                tmp.innerHTML = html;
                var lis = tmp.querySelectorAll('li');
                if (lis && lis.length) {
                    var out = [];
                    for (var i = 0; i < lis.length; i++) {
                        var t = lis[i].textContent.trim();
                        if (t) out.push(t);
                    }
                    return out;
                }
                if (/^.*<br/i.test(html)) {
                    return html.split(/<br\s*\/?>/i).map(function(s) {
                        return s.replace(/<[^>]+>/g, '').trim();
                    }).filter(Boolean);
                }
                return (tmp.textContent || '').split(/[\n,•|]+/).map(function(s) {
                    return s.trim();
                }).filter(Boolean);
            }

            // === Heuristic skill detector (no predefined word lists) ===
            function isSkillLike(s) {
                if (!s) return false;
                s = String(s).trim().replace(/^[^\w+.#-]+|[^\w+.#-]+$/g, "");
                if (!s) return false;

                if (/[0-9+#.]/.test(s)) return true; // C#, C++, .NET, Node.js
                if (/^[A-Z]{2,6}$/.test(s)) return true; // SQL, AWS, API, SDK, NLP
                if (/[A-Z].*[A-Z]/.test(s)) return true; // ReactJS, PowerBI
                if (/^[A-Z][a-z]+[A-Z][A-Za-z0-9]*$/.test(s)) return true; // CamelCase tech

                if (/^[A-Za-z]+$/.test(s)) {
                    if (s === s.toLowerCase()) return false; // ❗ drop all-lowercase (in/of/on/development)
                    if (s.length <= 2) return true; // R, C, Go
                    if (s.length <= 4 && /^[A-Z][a-z]*$/.test(s)) return true; // Git, Java, Bash
                    if (s.length >= 5 && /(sql|js|ml|db|ops|api|sdk)$/i.test(s)) return true;
                    return false;
                }
                return false;
            }


            // Use morphology-only filter for ALL chip groups (Matched/Missing/Timelines)
            function chipsLine(items) {
                if (!items || !items.length) return '<span class="answer-chip none">None</span>';
                var kept = [];
                for (var i = 0; i < items.length; i++) {
                    if (isSkillLike(items[i])) kept.push(items[i]);
                }
                if (!kept.length) return '<span class="answer-chip none">None</span>';
                var parts = [];
                for (var j = 0; j < kept.length; j++) {
                    parts.push('<span class="answer-chip" style="animation-delay:' + (j * 20) + 'ms">' + esc(kept[j]) + '</span>');
                }
                return parts.join(' ');
            }

            // Renders ALL JD rows for each resume
            function renderCards(perResume) {
                var results = document.getElementById('results');
                results.innerHTML = '';

                perResume.forEach(function(r) {
                    var head = document.createElement('h2');
                    head.textContent = 'Results for ' + r.name + ' (' + r.rows.length + ' JDs)';
                    results.appendChild(head);

                    if (!r.rows.length) {
                        var empty = document.createElement('div');
                        empty.className = 'card';
                        empty.textContent = 'No matches after filters';
                        results.appendChild(empty);
                        return;
                    }

                    r.rows.forEach(function(row) {
                        var card = document.createElement('div');
                        card.className = 'card';

                        var eduItems = htmlToItems(row.eduPeriods);
                        var expItems = htmlToItems(row.expPeriods);
                        var eduGapItems = htmlToItems(row.eduGaps);
                        var expGapItems = htmlToItems(row.expGaps);

                        card.innerHTML =
                            '<h3>' + row.jd + ' (' + row.score.toFixed(2) + '%)</h3>' +
                            '<div>Resume: ' + (row.rLoc || 'Not Mentioned') + ' • JD: ' + (row.jLoc || 'Not Mentioned') + '</div>' +
                            '<details open><summary>Matched Skills</summary><div class="chipline">' + chipsLine(row.matched) + '</div></details>' +
                            '<details><summary>Missing Skills</summary><div class="chipline">' + chipsLine(row.missing) + '</div></details>' +
                            '<details><summary>Education</summary><div class="chipline">' + chipsLine(eduItems) + '</div></details>' +
                            '<details><summary>Experience</summary><div class="chipline">' + chipsLine(expItems) + '</div></details>' +
                            '<details><summary>Education Timeline</summary><div class="chipline">' + chipsLine(eduGapItems) + '</div></details>' +
                            '<details><summary>Experience Timeline</summary><div class="chipline">' + chipsLine(expGapItems) + '</div></details>' +
                            '<details><summary>Time Difference from Education → First Job</summary><div class="chipline"><span class="answer-chip">' + (row.eduJobGap || '—') + '</span></div></details>';

                        results.appendChild(card);
                    });
                });
            }

            async function runMatch() {
                var statusEl = document.getElementById('status');
                var resumes = resumeInput.files,
                    jds = jdInput.files;
                if (!resumes.length) {
                    alert('Please upload at least one resume.');
                    return;
                }
                if (!jds.length) {
                    alert('Please upload at least one JD.');
                    return;
                }
                statusEl.textContent = 'processing…';

                var minPct = parseFloat(document.getElementById('minPct').value || '0');
                var minSkills = parseInt(document.getElementById('minSkills').value || '0', 10);
                var sortBy = document.getElementById('sortBy').value;

                var formDatas = [];
                for (var i = 0; i < resumes.length; i++) {
                    var res = resumes[i];
                    var fd = new FormData();
                    fd.append('resume', res, res.name);
                    for (var j = 0; j < jds.length; j++) {
                        var jd = jds[j];
                        fd.append('jd_files', jd, jd.name);
                    }
                    formDatas.push(fd);
                }

                try {
                    var tables = await Promise.all(formDatas.map(function(fd) {
                        return fetch('/upload', {
                            method: 'POST',
                            body: fd
                        }).then(function(r) {
                            return r.text();
                        });
                    }));
                    var parsed = tables.map(function(html, idx) {
                        var rows = parseResultTable(html).filter(function(r) {
                            return r.score >= minPct && r.matched.length >= minSkills;
                        });
                        rows.sort(function(a, b) {
                            return (sortBy === 'desc') ? (b.score - a.score) : (a.score - b.score);
                        });
                        return {
                            name: resumes[idx].name,
                            rows: rows
                        };
                    });
                    renderCards(parsed);
                    statusEl.textContent = 'ready';
                } catch (e) {
                    console.error(e);
                    statusEl.textContent = 'error';
                    alert('Something went wrong while matching. Check console for details.');
                }
            }

            document.getElementById('matchBtn').addEventListener('click', runMatch);
            document.getElementById('csvBtn').addEventListener('click', async function() {
                if (!resumeInput.files.length || !jdInput.files.length) {
                    alert('Upload a resume and at least one JD first.');
                    return;
                }
                var fd = new FormData();
                fd.append('resume', resumeInput.files[0], resumeInput.files[0].name);
                for (var j = 0; j < jdInput.files.length; j++) {
                    var jd = jdInput.files[j];
                    fd.append('jd_files', jd, jd.name);
                }
                var resp = await fetch('/download_csv', {
                    method: 'POST',
                    body: fd
                });
                var blob = await resp.blob();
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'resume_match_results.csv';
                a.click();
                URL.revokeObjectURL(url);
            });
        })();
    </script>
</body>

</html>